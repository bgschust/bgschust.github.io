<!DOCTYPE html>
<html>
<head>
  <title>Cropify: Specific Item Detail</title>
  <meta name="google-site-verification" content="xge8ZYlv0TNmO1n4LLsieIdXQe71VYy20LBcUl-wsUQ" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/specific-item-detail.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
  <script src="components/functions.js"></script>
</head>
<body>

  <h3 id="specificItem_Name">Specific Item Name</h3>
  <p>Produced by <span id="Producer">Producer not found</span>.</p>

  <h4>Fulfillment Method</h4>
  <input type="radio" id="selfPickup" name="fulfillmentMethod" value="selfPickup" checked>
  <label for="selfPickup">Self Pick-Up</label>

  <h4>Payment Method</h4>
  <input type="radio" id="payAtPickup" name="paymentMethod" value="payAtPickup" checked>
  <label for="payAtPickup">Pay at Pick-Up</label>

  <h4 class="markets">Markets</h4>
  <p>No markets found.</p>

</body>

<script id="initialize">
  const urlParams = new URLSearchParams(window.location.search);
  let specificItem_id = urlParams.get('specificItem_id');

  var headers = new Headers();
  headers.append("Content-Type", "application/json");
  headers.append("Authorization", "Token t48tRPtNQccyc6Q65klBDEP1QJqkwXw0");
  var requestOptions = {
      method: "get",
      headers: headers,
      redirect: "follow",
  };
</script>

<script id="specificItem">
  async function getSpecificItem() {

    let queryParams = [
      {"user_field_names": true}
    ];
    
    let url = buildURL(
      'https://api.baserow.io/api/database/rows/table/6844/' + specificItem_id + '/', 
      queryParams
    );

    try {
        let res = await fetch(url, requestOptions);
        res = await res.json();
        return await res;
    } catch (error) {
        console.log(error);
    }
  }

  let specificItem = async function renderSpecificItem() {
    let specificItem = {};
    specificItem = await getSpecificItem();
    
    document.querySelector('#specificItem_Name').textContent = specificItem.Name;
    if(specificItem.Producer && specificItem.Producer.length > 0) {
      document.querySelector('span#Producer').textContent = specificItem.Producer[0].value
    }
    
    return specificItem;
  }();
</script>

<script id="marketItems">
  async function getMarketItems() {

    let queryParams = [
      {"user_field_names": true},
      {"filter__field_825410__link_row_has": specificItem_id}
    ];
    
    let url = buildURL(
      'https://api.baserow.io/api/database/rows/table/127821/', 
      queryParams
    );

    try {
        let res = await fetch(url, requestOptions);
        res = await res.json();
        return await res.results;
    } catch (error) {
        console.log(error);
    }
  }

  let marketItems = async function renderMarketItems() {
    let records = [];
    records = await getMarketItems();
    console.log(records);
    
    if (records.length > 0) {
      // browser sorting
      records.forEach(record => {
        record.MarketName = record.Market[0].value;
      });
      records = _.sortBy(records, 'MarketName');

      // rendering
      document.querySelector('h4.markets+p').innerHTML = '';
      records.forEach(record => {
        let recordDiv = document.createElement('div');
        let recordRadioBtn = document.createElement('input');
        recordRadioBtn.setAttribute('type','radio');
        let recordLabel = document.createElement('label');
        let recordInput = document.createElement('input');
        recordInput.setAttribute('type','number');
        let recordButton = document.createElement('button');
        let recordBr = document.createElement('br');
        let recordQtyAvail = document.createElement('p');
        recordQtyAvail.classList.add('qtyAvail');

        recordRadioBtn.setAttribute('name','market');
        recordRadioBtn.setAttribute('id', JSON.stringify(record.Market[0]));
        recordLabel.textContent = record.Market[0].value;
        recordLabel.setAttribute('for', JSON.stringify(record.Market[0]));
        recordButton.textContent = '+';
        recordButton.value = JSON.stringify(record.Market[0]);
        recordQtyAvail.textContent = record.Quantity.toString() + ((record.Quantity) ? ' available' : '');

        recordDiv.appendChild(recordRadioBtn);
        recordDiv.appendChild(recordLabel);
        recordDiv.appendChild(recordInput);
        recordDiv.appendChild(recordButton);
        recordDiv.appendChild(recordBr);
        recordDiv.appendChild(recordQtyAvail);
        document.querySelector('h4.markets+p').append(recordDiv);
      });
    }
    return records;
  }();
</script>

</html>