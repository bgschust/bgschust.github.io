<!DOCTYPE html>
<html>
<head>
  <title>Cropify - Order Details</title>
  <meta name="google-site-verification" content="xge8ZYlv0TNmO1n4LLsieIdXQe71VYy20LBcUl-wsUQ" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="../images/favicon.png">
  <link rel="stylesheet" href="../public/style.css">
  <link rel="stylesheet" href="../components/components.css">
  <link rel="stylesheet" href="../user-admin/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
  <script src="../components/functions.js"></script>
  <script src="../components/components.js"></script>
</head>
<body>

  <div class="component topNavigation"></div>

  <div id="mainContainer">

    <div id="listingsSalesOrders">
      <div>
        <a href="../public/general-items.html">Listings</a>
      </div>
      <div class="selected">
        <a href="../user-admin/orders.html">Orders</a>
      </div>
      <div>
        <a href="../org-admin/sales.html">Sales</a>
      </div>
    </div>
    
    <p>Order Details: view your purchases for an order. Donations received may also appear here.</p>
    
    <div id="myOrderBasket" class="parentItemContainer">
      <h2>
        <img src="../images/icons8-left-50.png" alt="Back Arrow" class="iconBtn backBtn" />
        <span>Order not Found</span>
      </h2>
      <div id="basketSummary">No order summary found.</div>
    </div>

    <br /><br />

    <div id="searchContainer">
      <input type="text" id="search" placeholder="Search... (not yet functional)">
      <img src="../images/icons8-search-32.png" alt="searchIcon" class="iconBtn" />
    </div>

    <h3>Market Items</h3>
    
    <p class="placeholder">My order details will be here. 
      <!-- Please <a href="../public/sign-up.html">sign up</a> or <a href="../user-admin/log-in.html">log in</a>. -->
    </p>
    
    <ul id="myOrder_basketItems" class="cardList"></ul>

    <br />

  </div>

  <div class="component footer"></div>

</body>

<script id="initialize">
  document.querySelector('div.parentItemContainer .iconBtn.backBtn').addEventListener('click', function goBack(){
    window.location.href = './orders.html';
  });

  const urlParams = new URLSearchParams(window.location.search);
  let basket_ID = urlParams.get('basketID');

  var headers = new Headers();
  headers.append("Content-Type", "application/json");
  headers.append("Authorization", ""); // for Cropify Online DO Requests
  var requestOptions = {
      method: "get",
      headers: headers,
      redirect: "follow",
  };
</script>

<script id="authenticateUser">
  async function getRequest_userSharedToken() {
    let userID = '';
    let queryParams = [];

    if(document.cookie
      && getCookie('user')) {
      userID = JSON.parse(getCookie('user')).id;

      queryParams.push({"User_ID": userID});
      queryParams.push({"Request Reason": "Browsing order details"});

      headers.append("Authorization", "Password "+JSON.parse(getCookie('user')).Password);
      requestOptions.headers = headers;
    }

    let url = buildURL('https://hammerhead.cropify.org/cors-proxy/' // CORS proxy server
      + 'https://n8n.cropify.org/webhook/944e1074-bf6c-4130-89a7-8a86fa1d441f',
      queryParams);
    try {
        let res = await fetch(url, requestOptions);
        res = await res.json();
        return await res;
    } catch (error) {
        console.log(error);
    }
  }
</script>

<script id="parentItem_basket">
  async function getRequest_basket() {
    let headers = new Headers();
    headers.append("Content-Type", "application/json");
    let authToken = "";
    authToken = await getRequest_userSharedToken();
    authToken = authToken["Authorization Token"];
    headers.append("Authorization", "Token "+authToken);
    let requestOptions = {
        method: "get",
        headers: headers,
        redirect: "follow",
    };

    let queryParams = [
      {"User_ID": JSON.parse(getCookie('user')).id},
      {"Password": JSON.parse(getCookie('user')).Password},
      {"Basket_ID": basket_ID}
    ];

    let url = buildURL('https://hammerhead.cropify.org/cors-proxy/' // CORS proxy server
      + 'https://n8n.cropify.org/webhook/45b50ce4-a0a1-4d8d-aa72-814e28b41c6f', 
      queryParams);
    try {
        let res = await fetch(url, requestOptions);
        res = await res.json();
        return await res;
    } catch (error) {
        console.log(error);
    }
  }

  async function renderOrderSummary() {
    let orderBasket = {};
    let getRequest_order = await getRequest_basket();
    if(getRequest_order.statusMessage = "Order retrieved.") {
      orderBasket = getRequest_order.orderSummary;
    };
    
    document.querySelector('div#myOrderBasket>h2>span').textContent = "Order #"+orderBasket.id;
    //document.querySelectorAll('div#thisGeneralItem>h4>span')[1].textContent = 
    //  generalItem.Group[0].value + ': ' + generalItem.Category[0].value;
    //document.querySelector('div#thisGeneralItem>p').textContent = generalItem['Short Description'];
  };
  renderOrderSummary();
</script>

<script id="repurchaseItems">
  /*document.querySelector('').addEventListener('click', function repurchaseAllTheseOrderItems() {
    if(getCookie('user')) {
      
    } else {
      if(confirm('Please sign up or log in to do this.')) {
        
      }
    }
  });*/
</script>

</html>