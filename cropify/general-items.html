<!DOCTYPE html>
<html>
<head>
  <title>Cropify</title>
  <meta name="google-site-verification" content="xge8ZYlv0TNmO1n4LLsieIdXQe71VYy20LBcUl-wsUQ" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"></script>
</head>
<body>

  <iframe id="component_topNav" src="components/topNavigation.html"></iframe>

  <div id="mainContainer">
    <div id="listingsSalesOrders">
      <div class="selected">
        Listings
      </div>
      <div>
        <a href="orders.html">Orders</a>
      </div>
      <div>
        <a href="sales.html">Sales</a>
      </div>
    </div>
    
    <p>General Items: These are the general items on the marketplace.</p>
    <input type="text" placeholder="Search... (not working)">

    <h3>My Listings</h3>

    <h3>Community Listings</h3>
    <div class="filterContainer">

      <h4>Item Groups</h4>
      <ul id="groups"></ul>
      <h4>Categories</h4>
      <ul id="categories"></ul>

      <div class="filterDisplayContainer">
        <img src="images/icons8-filter-and-sort-50.png" alt="List Filters">
        <div id="groupsFilter">
          <label>Group</label><br />
          <input type="text" id="groupFilterInput" value="[1,2]" style="display:none;">
          <div><span>Initial Groups</span></div>
        </div>
        <div id="categoriesFilter">
          <label>Categories</label>
          <button>Reset</button><br />
          <input type="text" id="categoriesFilterInput" value="[3,4,5]" style="display:none;">
          <div><span>Initial Categories</span></div>
        </div>
        <div id="outOfStockFilter">
          <label for="outOfStockFilterCheckbox" style="cursor:pointer;">Show out-of-stock items?</label><br />
          <input type="checkbox" id="outOfStockFilterCheckbox">
        </div>
        <form id="sortGeneralItems">
          <label for="sort">Sort: </label><br />
          <select id="sort" name="cars">
            <option value="default">Default</option>
            <option value="nameAsc">Name: A to Z</option>
            <option value="nameDesc">Name: Z to A</option>
            <option value="specItemCtAsc">Specific Item Count: Ascending</option>
            <option value="specItemCtDesc">Specific Item Count: Descending</option>
          </select>
        </form>
      </div>
    </div>

    <ul id="generalItems"></ul>

    <a target="_blank" href="https://icons8.com/icon/85181/shopping-basket">Shopping Basket</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>
    <a target="_blank" href="https://icons8.com/icon/85147/male-user">Male User</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>
    <a target="_blank" href="https://icons8.com/icon/43428/filter-and-sort">Filter and Sort</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>
  </div>

</body>

<script id="initialize">
let groupsDefault = [{"id":1,"order":"1.00000000000000000000","Name":"Edible Harvests","Notes":"","Active":false,"General Items":[{"id":5,"value":"Tomato"},{"id":1,"value":"Apple"},{"id":2,"value":"Orange"},{"id":3,"value":"Pear"}],"General Items - Categories":[],"Parent Category":[{"id":9,"value":"Group"}]},{"id":10,"order":"10.00000000000000000000","Name":"Farm Services","Notes":"","Active":false,"General Items":[],"General Items - Categories":[],"Parent Category":[{"id":9,"value":"Group"}]},{"id":2,"order":"2.00000000000000000000","Name":"Artisan Foods & Beverages","Notes":"","Active":false,"General Items":[{"id":6,"value":"Sauerkraut"},{"id":7,"value":"Soft Pretzel"}],"General Items - Categories":[],"Parent Category":[{"id":9,"value":"Group"}]}];
let categoriesDefault = [{"id":1,"order":"1.00000000000000000000","Name":"Edible Harvests","Notes":"","Active":false,"General Items":[{"id":5,"value":"Tomato"},{"id":1,"value":"Apple"},{"id":2,"value":"Orange"},{"id":3,"value":"Pear"}],"General Items - Categories":[]},{"id":2,"order":"2.00000000000000000000","Name":"Artisan Foods & Beverages","Notes":"","Active":false,"General Items":[{"id":6,"value":"Sauerkraut"},{"id":7,"value":"Soft Pretzel"}],"General Items - Categories":[]},{"id":3,"order":"3.00000000000000000000","Name":"Vegetables","Notes":"","Active":false,"General Items":[],"General Items - Categories":[{"id":5,"value":"Tomato"}]},{"id":4,"order":"4.00000000000000000000","Name":"Fruit","Notes":"","Active":false,"General Items":[],"General Items - Categories":[{"id":1,"value":"Apple"},{"id":2,"value":"Orange"},{"id":3,"value":"Pear"}]},{"id":5,"order":"5.00000000000000000000","Name":"Fermented Foods","Notes":"","Active":false,"General Items":[],"General Items - Categories":[{"id":6,"value":"Sauerkraut"}]},{"id":6,"order":"6.00000000000000000000","Name":"Baked Goods","Notes":"","Active":false,"General Items":[],"General Items - Categories":[{"id":7,"value":"Soft Pretzel"}]}];
let generalItemsDefault = [{"id":1,"order":"1.00000000000000000000","Name":"Apple","Notes":"My fuji bag.","Active":true},{"id":2,"order":"2.00000000000000000000","Name":"Orange","Notes":null,"Active":false},{"id":3,"order":"3.00000000000000000000","Name":"Pear","Notes":null,"Active":false},{"id":4,"order":"4.00000000000000000000","Name":"","Notes":"","Active":false}];

const filterDefault = {
  group: [430],
  groupObjects: [{id: 430, value: 'Edible Harvests'}],
  categories: [484,485,498,493],
  categoryObjects: [{id: 484, value:'Eggs & Dairy'},{id: 485, value:'Fruit'},{id: 498, value:'Vegetables'},{id: 493, value:'Omnivore Meat'}],
  show_outOfStock: false,
};
let filter = {};
Object.assign(filter, filterDefault);

let sortBy = 'default';

// assign filter defaults to HTML inputs
document.querySelector('input#groupFilterInput').value = JSON.stringify(filter.group);
document.querySelector('input#categoriesFilterInput').value = JSON.stringify(filter.categories);
</script>

<script id="groups">
var headers_groups = new Headers();
headers_groups.append("Content-Type", "application/json");
headers_groups.append("Authorization", "Token t48tRPtNQccyc6Q65klBDEP1QJqkwXw0");
var requestOptionsGroups = {
    method: "get",
    headers: headers_groups,
    redirect: "follow",
};

async function getGroups() {
  let queryParams = [
    {"user_field_names": true},
    {"size": 100},
    {"filter__field_819526__link_row_has": 347},
  ];
  
  let query = '';
  queryParams.forEach(function URIencode(item, index, arr){
    let k = Object.keys(item)[0];
    let v = item[k];
    query += encodeURIComponent(k)+'='+encodeURIComponent(v);
    if (index < queryParams.length - 1) {
      query += '&';
    }
  });
  if (query) {
    query = '?'+ query;
  }

  let url = 'https://api.baserow.io/api/database/rows/table/126754/' + query;
  
  try {
      let res = await fetch(url, requestOptionsGroups);
      res = await res.json();
      return await res.results;
  } catch (error) {
      console.log(error);
  }
}

async function renderGroups() {
  let groups = [];
  groups = await getGroups();
  (groups.length == 0) ? groups = groupsDefault : groups;
  
  // browser sorting
  groups = _.sortBy(groups, 'Name');
  
  groupsContainer.innerHTML = '';
  groups.forEach(record => {
    if (filter.group.indexOf(record.id) >= 0 
        && _.pluck(filter.groupObjects, 'id').indexOf(record.id) == -1) {
      filter.groupObjects.push({id: record.id, value: record.Name});
    }
    filter.groupNames = _.pluck(filter.groupObjects, 'value').sort().join(', ');
    document.querySelector('div#groupsFilter>div>span').textContent = filter.groupNames;

    let groupLabel = document.createElement("label");
    groupLabel.className = 'iconSelector';
    let groupSpan1 = document.createElement("span");
    let groupBr = document.createElement("br");
    let groupSpan2 = document.createElement("span");
    let groupBr2 = document.createElement("br");
    let groupImg = document.createElement("img");
    let groupRadioBtn = document.createElement("input");
    groupRadioBtn.setAttribute('type', 'radio');
    groupRadioBtn.setAttribute('name', 'group');
    groupRadioBtn.className = 'iconSelector';
    groupRadioBtn.checked = false;
    if (filter.group[0] == record.id) {
      groupRadioBtn.checked = true;
    }
    let groupPseudoLabel = document.createElement("label");
    groupPseudoLabel.className = 'groupPseudoLabel';

    let recordSimple = JSON.stringify({id: record['id'], value: record['Name']});
    groupRadioBtn.setAttribute('id', recordSimple);
    groupPseudoLabel.textContent = '';
    groupPseudoLabel.setAttribute('for', recordSimple);
    groupLabel.setAttribute('for', recordSimple);

    groupSpan1.textContent = record['Line 1'] || 'Null';
    groupSpan2.textContent = record['Line 2'] || 'Null';
    let imgSrc = record.Image[0].url;
    groupImg.setAttribute('src', imgSrc);

    groupLabel.appendChild(groupSpan1);
    groupLabel.appendChild(groupBr);
    groupLabel.appendChild(groupSpan2);
    groupLabel.appendChild(groupBr2);
    groupLabel.appendChild(groupImg);
    groupLabel.appendChild(groupRadioBtn);
    groupLabel.appendChild(groupPseudoLabel);
    groupsContainer.appendChild(groupLabel);

  });
  return groups;
}
</script>

<script id="categories">
var headers_categories = new Headers();
headers_categories.append("Content-Type", "application/json");
headers_categories.append("Authorization", "Token t48tRPtNQccyc6Q65klBDEP1QJqkwXw0");
var requestOptionsCategories = {
    method: "get",
    headers: headers_categories,
    redirect: "follow",
};

async function getCategories() {
  let queryParams = [
    {"user_field_names": true},
    {'filter__field_822699__equal': 'General Item Group'},
    {"size": 200},
  ];

  // database filtering
  /* if (typeof filter.group == 'object') {
    filter.group.forEach(function URLfilterGroups(value, index, arr) {
      queryParams.push({'filter__field_822692__link_row_has': 347});
      if (index < filter.group.length - 1) {
        queryParams.push({'filter_type': 'OR'});
      }
    });
  } */
  
  let query = '';
  queryParams.forEach(function URIencode(item, index, arr){
    let k = Object.keys(item)[0];
    let v = item[k];
    query += encodeURIComponent(k)+'='+encodeURIComponent(v);
    if (index < queryParams.length - 1) {
      query += '&';
    }
  });
  if (query) {
    query = '?'+ query;
  }

  let url = 'https://api.baserow.io/api/database/rows/table/126754/' + query;
  
  try {
      let res = await fetch(url, requestOptionsCategories);
      res = await res.json();
      return await res.results;
  } catch (error) {
      console.log(error);
  }
}

async function renderCategories() {
  let categories = '';
  categories = await getCategories();
  (!categories) ? categories = categoriesDefault : categories;
  
  // update filter display for categories
  categories.forEach(category => {
    if (filter.categories.indexOf(category.id) >= 0 
        && _.pluck(filter.categoryObjects, 'id').indexOf(category.id) == -1) {
      filter.categoryObjects.push({id: category.id, value: category.Name});
    } else if(filter.categories.indexOf(category.id) >= 0
    && _.pluck(filter.categoryObjects, 'id').indexOf(category.id) >= 0) {
      // this is to dynamically remove objects from filter.categoryObjects (unfinished)
    } else {
    }
  });
  filter.categoryNames = _.pluck(filter.categoryObjects, 'value').sort().join(', ');
  document.querySelector('div#categoriesFilter>div>span').textContent = filter.categoryNames;

  // browser filtering
  if (filter.group.length > 0) {
    categories = categories.filter(function filterByGroup(record){
      let id = 0;
      if (record['Parent Category'].length == 0 || undefined) {
        id = 'Null';
      } else {
        id = record['Parent Category'][0]['id'];
      }  
      return id == filter.group[0];
    });
  }

  // browser sorting
  categories = _.sortBy(categories, 'Name');

  categoriesContainer.innerHTML = '';
  categories.forEach(category => {
    let categoryLi = document.createElement("li");
    categoryLi.className = 'categoryLi';
    let categoryCheckbox = document.createElement("input");
    categoryCheckbox.className = 'css-checkbox';
    let categoryLabel = document.createElement("label");

    categoryCheckbox.setAttribute('type','checkbox');
    categoryCheckbox.checked = false;
    if (filter.categories.indexOf(category.id) >= 0) {
      categoryCheckbox.checked = true;
    }
    let categoryBasic = JSON.stringify({id: category['id'], value: category['Name']});
    categoryCheckbox.setAttribute('id', categoryBasic);
    categoryLabel.textContent = category['Name'] || 'Null';
    categoryLabel.setAttribute('for', categoryBasic);

    categoryLi.appendChild(categoryCheckbox);
    categoryLi.appendChild(categoryLabel);
    categoriesContainer.appendChild(categoryLi);

  });
  return categories;
}
</script>

<script id="generalItems">
var headers_generalItems = new Headers();
headers_generalItems.append("Content-Type", "application/json");
headers_generalItems.append("Authorization", "Token t48tRPtNQccyc6Q65klBDEP1QJqkwXw0");
var requestOptionsGeneralItems = {
    method: "get",
    headers: headers_generalItems,
    redirect: "follow",
};

async function getGeneralItems() {

  let queryParams = [
    {"user_field_names": true},
    {"size": 200},
  ];

  // database filtering
  if (typeof filter.categories == 'object') {
    filter.categories.forEach(function URLfilterCategories(value, index, arr) {
      queryParams.push({'filter__field_819247__link_row_has': value});
      if (index < filter.categories.length - 1) {
        queryParams.push({'filter_type': 'OR'});
      }
    });
  }
  
  let query = '';
  queryParams.forEach(function URIencode(item, index, arr){
    let k = Object.keys(item)[0];
    let v = item[k];
    query += encodeURIComponent(k)+'='+encodeURIComponent(v);
    if (index < queryParams.length - 1) {
      query += '&';
    }
  });
  if (query) {
    query = '?'+ query;
  }

  let url = 'https://api.baserow.io/api/database/rows/table/6842/' + query;

  try {
      let resGeneralItems = await fetch(url, requestOptionsGeneralItems);
      resGeneralItems = await resGeneralItems.json();
      return await resGeneralItems.results;
  } catch (error) {
      console.log(error);
  }
}

async function renderGeneralItems() {
  let generalItems = '';
  generalItems = await getGeneralItems();
  (!generalItems) ? generalItems = generalItemsDefault : generalItems;
  
  // browser filtering
  if (filter.show_outOfStock == false) {
    generalItems = generalItems.filter(function filterShow_outOfStock(record){
      return record['Specific Item Count'] > 0;
    });
  }

  // browser sorting
  if(sortBy == ('default' || undefined)){
  } else if(sortBy=='nameAsc') {
    generalItems = _.sortBy(generalItems, 'Name');
  } else if(sortBy=='nameDesc') {
    generalItems = _.sortBy(generalItems, 'Name').reverse();
  } else if(sortBy=='specItemCtAsc'){
    generalItems = _.sortBy(generalItems, 'Specific Item Count')
  } else if(sortBy=='specItemCtDesc'){
    generalItems = _.sortBy(generalItems, 'Specific Item Count').reverse();
  }

  let generalItemsContainer = document.querySelector('ul#generalItems');
  generalItemsContainer.innerHTML = '';
  generalItems.forEach(generalItem => {

    let generalItemDiv = document.createElement("div");
    generalItemDiv.className = 'img-card';
    let generalItemDivP1 = document.createElement("p");
    let generalItemDivP2 = document.createElement("p");

    generalItemDivP1.textContent = generalItem.Name || 'Null';
    generalItemDivP2.textContent = generalItem['Specific Item Count'] || 'Null';

    generalItemDiv.appendChild(generalItemDivP1);
    generalItemDiv.appendChild(generalItemDivP2);
    generalItemsContainer.appendChild(generalItemDiv);

  });
  return generalItems;
}
</script>

<script id="processFilters">
// initially render lists
let groups = renderGroups();
let categories = renderCategories();
let generalItems = renderGeneralItems();

// change filter inputs to reflect checkbox and radio button clicks
let groupsContainer = document.querySelector('ul#groups');
groupsContainer.addEventListener('change', adjustGroups);
function adjustGroups(event){
  filter.groupObjects = [];
  filter.groupObjects.push(JSON.parse(event.target.id));
  filter.group = _.pluck(filter.groupObjects,'id');
  filter.groupNames = _.pluck(filter.groupObjects, 'value').sort().join(', ');
  document.querySelector('div#groupsFilter>div>span').textContent = filter.groupNames;
  filterGroupInput.value = JSON.stringify(filter.group);
  renderCategories();
}
let categoriesContainer = document.querySelector('ul#categories');
categoriesContainer.addEventListener('change', adjustCategories);
function adjustCategories(event){
  filter.categoryObjects = _.sortBy(filter.categoryObjects, 'id');
  filter.categories = _.pluck(filter.categoryObjects,'id');
  if (event.target.checked) {
    filter.categoryObjects.push(JSON.parse(event.target.id));
  } else if (!event.target.checked) {
    let i = filter.categories.indexOf(JSON.parse(event.target.id).id);
    if(i >= 0) {
      filter.categoryObjects.splice(i,1);
    }
  }
  filter.categoryObjects = _.sortBy(filter.categoryObjects, 'id');
  filter.categories = _.pluck(filter.categoryObjects,'id');
  filter.categoryNames = _.pluck(filter.categoryObjects, 'value').sort().join(', ');
  document.querySelector('div#categoriesFilter>div>span').textContent = filter.categoryNames;
  filterCategoriesInput.value = JSON.stringify(filter.categories);
  renderGeneralItems();
  return filter;
}

// get filter input values and re-render
let filterGroupInput = document.querySelectorAll('div.filterDisplayContainer>div>input')[0];
filter.group = JSON.parse(filterGroupInput.value);
filterGroupInput.addEventListener('change', function filterGroups() {
  filter.group = JSON.parse(filterGroupInput.value);
  if (filter.group.length >= 1) {
    renderCategories();
  }
});
let filterCategoriesInput = document.querySelectorAll('div.filterDisplayContainer>div>input')[1];
filter.categories = JSON.parse(filterCategoriesInput.value);
filterCategoriesInput.addEventListener('change', function getFilterCategories() {
  filter.categories = JSON.parse(filterCategoriesInput.value);
  if (filter.categories.length >= 1) {
    renderGeneralItems();
  }
});
document.querySelector('div#categoriesFilter button').addEventListener('click', resetCategories); 
function resetCategories() {
  filter.group = filterDefault.group;
  filter.groupObjects = filterDefault.groupObjects;
  filter.groupNames = _.pluck(filter.groupObjects, 'value');
  filterGroupInput.value = JSON.stringify(filter.group);
  filter.categories = filterDefault.categories;
  filter.categoryObjects = filterDefault.categoryObjects;
  filter.categoryNames = _.pluck(filter.categoryObjects, 'value');
  filterCategoriesInput.value = JSON.stringify(filter.categories);
  renderGroups();
  renderCategories();
  renderGeneralItems();
}
let filterShowOutOfStockCheckbox = document.querySelectorAll('div.filterDisplayContainer>div>input')[2];
filter.show_outOfStock = filterShowOutOfStockCheckbox.checked;
filterShowOutOfStockCheckbox.addEventListener('change', function getFilterCheckbox() {
  filter.show_outOfStock = filterShowOutOfStockCheckbox.checked;
  renderGeneralItems();
});

// get sort input values and re-render
let sortGeneralItems = document.querySelector('form#sortGeneralItems>select');
function getSorted()  {
  sortBy = sortGeneralItems.value;
  renderGeneralItems();
}
sortGeneralItems.addEventListener('change', getSorted);
</script>

</html>